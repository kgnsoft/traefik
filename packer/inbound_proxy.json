{   "_Copyright": "2019",
    "_author": "NCDS Infrastructure Pod",
    "min_packer_version": "0.12.0",
    "variables": {
      "aws_region": "eu-west-2",
      "iam_instance_profile": "",
      "inboundproxy_version": "1.0.0",
      "vpc_id": "vpc-0944785b632e2e98c", 
      "subnet_id": "subnet-0890cea88a43b0113",
      "name": "InboundProxy-Amazon-Linux2-AMI",
      "connectivity_account_id": "260563756810"
    },
    "builders": [
      { "ami_users": "{{user `connectivity_account_id`}}",
        "ami_name": "{{user `name`}}-{{timestamp}}",
        "ami_description": "Inbound Proxy with Traefik on Amazon Linux 2",
        "subnet_id": "{{user `subnet_id`}}",
        "iam_instance_profile": "{{user `iam_instance_profile`}}",
        "instance_type": "t2.micro",
        "region": "{{user `aws_region`}}",
        "type": "amazon-ebs",
        "source_ami_filter": {
          "filters": {
            "virtualization-type": "hvm",
            "architecture": "x86_64",
            "name": "Golden-Amazon-Linux2-AMI*",
            "block-device-mapping.volume-type": "gp2",
            "root-device-type": "ebs"
          },
          "owners": ["202696833239"],
          "most_recent": true
        },
        "ssh_username": "ec2-user",
        "tags": {
          "OS": "Amazon Linux 2",
          "SourceAMIName": "{{ .SourceAMIName }}",
          "SourceAMI": "{{ .SourceAMI }}",
          "InboundProxyVersion": "{{user `inboundproxy_version`}}",
          "BuildTime": "{{isotime}}",
          "CreatedBy": "Packer",
          "Name": "InboundProxy"
        }
      }
    ],
    "provisioners": [
      {
        "type": "shell",
        "script": "scripts/docker.sh"
      },
      {
        "type": "ansible",
	"playbook_file": "../ansible/play.yml",
        "ansible_env_vars": [ "ANSIBLE_HOST_KEY_CHECKING=False", "ANSIBLE_SSH_ARGS='-o ForwardAgent=yes -o ControlMaster=auto -o ControlPersist=60s'", "ANSIBLE_NOCOLOR=True" ]
      },	
      {
        "type": "shell",
        "script": "scripts/cleanup.sh"
      }
    ]
  }

